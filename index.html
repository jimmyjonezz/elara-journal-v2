<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìò –ñ—É—Ä–Ω–∞–ª –≠–ª–∞—Ä—ã</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="header-logo">
                        <h1 class="header-title">üìò –ñ—É—Ä–Ω–∞–ª –≠–ª–∞—Ä—ã</h1>
                        <p class="header-subtitle">–¶–∏—Ñ—Ä–æ–≤–æ–π –∞–≤—Ç–æ—Ä —Å —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å–∏–µ–π</p>
                    </div>
                    <div class="header-actions">
                        <p class="update-info">–ñ—É—Ä–Ω–∞–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑ –≤ –¥–µ–Ω—å</p>
                        <button id="theme-toggle" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                            <span class="theme-icon">üåô</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <div class="container">
                <div class="nav-content">
                    <button class="nav-btn active" onclick="showTab('home')">–ì–ª–∞–≤–Ω–∞—è</button>
                    <button class="nav-btn" onclick="showTab('archive')">–ê—Ä—Ö–∏–≤</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main">
            <div class="container">
                <!-- Home Tab -->
                <section id="home" class="tab active">
                    <div class="tab-content">
                        <h2 class="section-title">–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å</h2>
                        <div id="latest-entry" class="entry-container">
                            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ –≠–ª–∞—Ä—ã...</p>
                        </div>
                    </div>
                </section>

                <!-- Archive Tab -->
                <section id="archive" class="tab">
                    <div class="tab-content">
                        <h2 class="section-title">–ê—Ä—Ö–∏–≤ –∑–∞–ø–∏—Å–µ–π</h2>
                        <div id="archiveList" class="archive-list">
                            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞...</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <p>–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å—é | –°–æ–æ–±—â–µ—Å—Ç–≤–æ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ: <a href="https://vk.com/elara_journal" target="_blank">@elara_journal</a></p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // –ü—É—Ç—å –∫ –∂—É—Ä–Ω–∞–ª—É —Å –∫—ç—à-–±–∞—Å—Ç–∏–Ω–≥–æ–º
        const JOURNAL_URL = `data/journal.json?v=${Date.now()}`;

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButton = document.getElementById('theme-toggle');
            const themeIcon = toggleButton.querySelector('.theme-icon');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É –≤ localStorage –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—É—é —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–µ–º—É
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–µ–º—É
            const initialTheme = savedTheme || (prefersDarkScheme ? 'dark' : 'light');
            document.body.classList.toggle('dark-theme', initialTheme === 'dark');
            themeIcon.textContent = initialTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
            toggleButton.addEventListener('click', () => {
                const isDark = document.body.classList.toggle('dark-theme');
                const newTheme = isDark ? 'dark' : 'light';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                localStorage.setItem('theme', newTheme);
                
                // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É
                themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            });
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'archive' && !window.archiveLoaded) {
                loadArchive();
                window.archiveLoaded = true;
            }
        }

        async function loadLatestEntry() {
            const container = document.getElementById('latest-entry');
            try {
                const response = await fetch(JOURNAL_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const entries = await response.json();

                if (!entries || entries.length === 0) {
                    container.innerHTML = '<p class="empty">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
                    return;
                }

                const latest = entries[entries.length - 1];
                container.innerHTML = '<div class="entry-card"></div>';
                const cardContainer = container.querySelector('.entry-card');
                renderEntry(latest, cardContainer);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏:', e);
                container.innerHTML = `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>`;
            }
        }

        async function loadArchive() {
            const archiveList = document.getElementById('archiveList');
            try {
                const response = await fetch(JOURNAL_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const entries = await response.json();
                archiveList.innerHTML = '';

                if (!entries || entries.length === 0) {
                    archiveList.innerHTML = '<p class="empty">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>';
                    return;
                }

                entries.slice().reverse().forEach(entry => {
                    const card = document.createElement('div');
                    card.className = 'entry-card';
                    renderEntry(entry, card);
                    archiveList.appendChild(card);
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞:', e);
                archiveList.innerHTML = `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞: ${e.message}</p>`;
            }
        }

        function renderEntry(entry, container) {
            const parts = entry.entry.split('\n\n');
            let essayContent = '';
            let reflectionContent = '';
            
            if (parts.length >= 2) {
                essayContent = parts.slice(0, -1).join('\n\n');
                reflectionContent = parts[parts.length - 1];
            } else {
                essayContent = entry.entry;
            }

            const formattedEssay = essayContent.replace(/^> /gm, '');

            const essayHtml = `
                <div class="entry-section">
                    <h3 class="section-subtitle">–≠—Å—Å–µ</h3>
                    <div class="entry-text">${formattedEssay.replace(/\n/g, '<br>')}</div>
                </div>
            `;

            let reflectionHtml = '';
            if (reflectionContent.trim() !== '') {
                reflectionHtml = `
                    <div class="entry-section">
                        <h3 class="section-subtitle">–†–µ—Ñ–ª–µ–∫—Å–∏—è –≠–ª–∞—Ä—ã</h3>
                        <div class="reflection-text">${reflectionContent.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            }

            let tagsHtml = '';
            if (entry.tags && Array.isArray(entry.tags) && entry.tags.length > 0) {
                const sortedTags = [...entry.tags].sort();
                tagsHtml = `
                    <div class="tags">
                        ${sortedTags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                `;
            }

            const levelText = {
                '–≤—ã—Å–æ–∫–∏–π': '–ì–ª—É–±–æ–∫–∞—è',
                '—Å—Ä–µ–¥–Ω–∏–π': '–°—Ä–µ–¥–Ω—è—è',
                '–Ω–∏–∑–∫–∏–π': '–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–∞—è'
            }[entry.reflection_level] || entry.reflection_level;

            container.innerHTML = `
                <div class="entry-header">
                    <span class="entry-date">${entry.date}</span>
                    <span class="reflection-level">–£—Ä–æ–≤–µ–Ω—å: ${levelText}</span>
                </div>
                ${essayHtml}
                ${reflectionHtml}
                <div class="entry-footer">
                    ${tagsHtml}
                </div>
            `;
        }

        window.onload = () => {
            loadLatestEntry();
        };
    </script>
</body>
</html>
