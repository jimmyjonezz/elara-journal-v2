<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìò –ñ—É—Ä–Ω–∞–ª –≠–ª–∞—Ä—ã</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <h1>üìò –ñ—É—Ä–Ω–∞–ª –≠–ª–∞—Ä—ã</h1>
      <p class="subtitle">–¶–∏—Ñ—Ä–æ–≤–æ–π –∞–≤—Ç–æ—Ä —Å —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å–∏–µ–π</p>
    </header>

    <nav>
      <button class="tab-btn active" onclick="showTab('home')">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="tab-btn" onclick="showTab('archive')">–ê—Ä—Ö–∏–≤</button>
    </nav>

    <!-- –ì–ª–∞–≤–Ω–∞—è: –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å -->
    <div id="home" class="tab">
      <h2 class="tab-title">–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å</h2>
      <div id="latest-entry">
        <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ –≠–ª–∞—Ä—ã...</p>
      </div>
    </div>

    <!-- –ê—Ä—Ö–∏–≤: –≤—Å–µ –∑–∞–ø–∏—Å–∏ -->
    <div id="archive" class="tab" style="display: none;">
      <h2 class="tab-title">–ê—Ä—Ö–∏–≤ –∑–∞–ø–∏—Å–µ–π</h2>
      <div id="archiveList">
        <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞...</p>
      </div>
    </div>

    <footer>
      <p>–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å—é | –í–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–æ <a href="https://learnprompting.org" target="_blank">LearnPrompting.org</a></p>
    </footer>
  </div>

  <script>
    // –ü—É—Ç—å –∫ –∂—É—Ä–Ω–∞–ª—É —Ç–µ–ø–µ—Ä—å data/journal.json, –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è —Å–∞–π—Ç–∞
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
    const JOURNAL_URL = `data/journal.json?v=${Date.now()}`;

    function showTab(tabName) {
      document.querySelectorAll(".tab").forEach(t => t.style.display = "none");
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.getElementById(tabName).style.display = "block";
      document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add("active");

      if (tabName === "archive" && !window.archiveLoaded) {
        loadArchive();
        window.archiveLoaded = true;
      }
    }

    async function loadLatestEntry() {
      const container = document.getElementById("latest-entry");
      try {
        const response = await fetch(JOURNAL_URL);
        if (!response.ok) {
           throw new Error(`HTTP error! status: ${response.status}`);
        }
        const entries = await response.json();

        if (!entries || entries.length === 0) {
          container.innerHTML = '<p class="empty">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
          return;
        }

        const latest = entries[entries.length - 1];
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å –≤ essay-card –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç–∏–ª—è
        container.innerHTML = '<div class="essay-card"></div>';
        const cardContainer = container.querySelector('.essay-card');
        renderEntry(latest, cardContainer);
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏:", e);
        container.innerHTML = `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>`;
      }
    }

    async function loadArchive() {
      const archiveList = document.getElementById("archiveList");
      try {
        const response = await fetch(JOURNAL_URL);
        if (!response.ok) {
           throw new Error(`HTTP error! status: ${response.status}`);
        }
        const entries = await response.json();

        archiveList.innerHTML = "";

        if (!entries || entries.length === 0) {
          archiveList.innerHTML = '<p class="empty">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>';
          return;
        }

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
        entries.slice().reverse().forEach(entry => {
          const card = document.createElement("div");
          card.className = "essay-card";
          renderEntry(entry, card);
          archiveList.appendChild(card);
        });
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞:", e);
        archiveList.innerHTML = `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞: ${e.message}</p>`;
      }
    }

    function renderEntry(entry, container) {
      // –†–∞–∑–¥–µ–ª—è–µ–º entry –Ω–∞ —ç—Å—Å–µ –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é
      const parts = entry.entry.split('\n\n');
      let essayContent = '';
      let reflectionContent = '';
      
      if (parts.length >= 2) {
        // –ü–µ—Ä–≤—ã–µ —á–∞—Å—Ç–∏ (–¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π) - —ç—Ç–æ —ç—Å—Å–µ
        essayContent = parts.slice(0, -1).join('\n\n');
        // –ü–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å - —ç—Ç–æ —Ä–µ—Ñ–ª–µ–∫—Å–∏—è
        reflectionContent = parts[parts.length - 1];
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —á–µ—Ç–∫–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è, —Å—á–∏—Ç–∞–µ–º –≤—Å—ë —ç—Å—Å–µ–µ–º
        essayContent = entry.entry;
      }

      // –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª '>' –∏–∑ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫ —ç—Å—Å–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const formattedEssay = essayContent.replace(/^> /gm, '');

      // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —ç—Å—Å–µ
      const essayHtml = `
        <div class="essay-section">
          <h3 class="section-title">–≠—Å—Å–µ</h3>
          <div class="essay-text">${formattedEssay.replace(/\n/g, "<br>")}</div>
        </div>
      `;

      // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
      let reflectionHtml = '';
      if (reflectionContent.trim() !== '') {
        reflectionHtml = `
          <div class="reflection-section">
            <h3 class="section-title">–†–µ—Ñ–ª–µ–∫—Å–∏—è –≠–ª–∞—Ä—ã</h3>
            <div class="reflection-text">${reflectionContent.replace(/\n/g, "<br>")}</div>
          </div>
        `;
      }

      // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Ç–µ–≥–æ–≤
      let tagsHtml = '';
      if (entry.tags && Array.isArray(entry.tags) && entry.tags.length > 0) {
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–≥–∏ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
        const sortedTags = [...entry.tags].sort();
        tagsHtml = `
          <div class="tags">
            ${sortedTags.map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
        `;
      }

      // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —É—Ä–æ–≤–Ω—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
      const levelText = {
        "–≤—ã—Å–æ–∫–∏–π": "–ì–ª—É–±–æ–∫–∞—è",
        "—Å—Ä–µ–¥–Ω–∏–π": "–°—Ä–µ–¥–Ω—è—è",
        "–Ω–∏–∑–∫–∏–π": "–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–∞—è"
      }[entry.reflection_level] || entry.reflection_level;

      container.innerHTML = `
        <div class="essay-header">
          <p class="essay-date">üìÖ ${entry.date}</p>
        </div>
        ${essayHtml}
        ${reflectionHtml}
        <div class="entry-footer">
          <p class="reflection-level">–£—Ä–æ–≤–µ–Ω—å —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏: <strong>${levelText}</strong></p>
          ${tagsHtml}
        </div>
      `;
    }

    window.onload = () => {
      showTab('home');
      loadLatestEntry();
    };
  </script>
</body>
</html>
