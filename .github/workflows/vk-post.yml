name: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ

on:
  workflow_dispatch:
  workflow_run:
    workflows: [–ù–æ–≤–æ–µ —ç—Å—Å–µ + –∞–Ω–∞–ª–∏–∑]
    types:
      - completed

jobs:
  post-to-vk:
    # –£–±—Ä–∞–ª–∏ 'if' –æ—Ç—Å—é–¥–∞ ‚Äî –æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å workflow_run
    runs-on: ubuntu-latest

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–∏–µ —á–µ—Ä–µ–∑ steps
    steps:
      - name: üîπ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ workflow
        run: |
          echo "–ü—Ä–µ–¥—ã–¥—É—â–∏–π workflow –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º: ${{ github.event.workflow_run.conclusion }}"
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "‚ùå –ü—Ä–µ–¥—ã–¥—É—â–∏–π workflow –Ω–µ —É–¥–∞–ª—Å—è –∏–ª–∏ –±—ã–ª –æ—Ç–º–µ–Ω—ë–Ω. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."
            exit 1  # –ù–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥
          fi

      - name: üîπ Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install requests vk-api

      - name: üîπ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –í–ö
        env:
          VK_GROUP_ID: ${{ secrets.VK_GROUP_ID }}
          VK_ACCESS_TOKEN: ${{ secrets.VK_ACCESS_TOKEN }}
          VK_ALBUM_ID: ${{ secrets.VK_ALBUM_ID }}
        run: |
          python vk/vk_poster.py

      # --- –ù–û–í–´–ô –®–ê–ì: —Ñ–∏–∫—Å–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Git ---
      - name: üîπ Commit and push deleted image
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ data/images/
          if [[ -n "$(git status --porcelain data/images/)" ]]; then
            echo "üñºÔ∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ data/images/ (—Ñ–∞–π–ª—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ)."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add data/images/
            git commit -m "üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ data/images/"
            # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ç–∫—É –ø–µ—Ä–µ–¥ –ø—É—à–µ–º, –∏—Å–ø–æ–ª—å–∑—É—è rebase –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è merge-–∫–æ–º–º–∏—Ç–∞
            git pull --rebase origin ${{ github.ref_name }} || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Ç–∫–∏ –ø–µ—Ä–µ–¥ –ø—É—à–µ–º (–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–Ω—Ñ–ª–∏–∫—Ç)."
              exit 1
            }
            git push
            echo "‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –≤ Git –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π."
          else
            echo "‚ÑπÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ data/images/ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ (—Ñ–∞–π–ª –º–æ–≥ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏–ª–∏ –Ω–µ –±—ã—Ç—å —É–¥–∞–ª—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ)."
          fi
        shell: bash
      # --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –®–ê–ì–ê ---
