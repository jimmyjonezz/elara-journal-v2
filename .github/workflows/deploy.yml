name: Deploy Journal

on:
  schedule:
    # Запуск раз в день, например, в 12:00 UTC
    - cron: '0 12 * * *'
  workflow_dispatch: # Для ручного запуска

jobs:
  generate-entry-and-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Node.js dependencies
        run: npm install

      - name: Generate new entry
        run: node src/generate_entry.js

      # --- НОВЫЙ ШАГ: Generate Image ---
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install replicate requests # Убедись, что эти библиотеки в requirements.txt

      - name: Generate image with Replicate
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: python src/generate_image.py
      # --- Конец нового шага ---

      - name: Commit and push if there are changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat: update journal and generated image [skip ci]"
          file_pattern: 'data/journal.json data/images/* data/latest_image_prompt.txt data/literary_analysis.json data/tag_statistics.json'
          # Убедись, что file_pattern включает новые изображения (data/images/*)

      # (Опционально) Запуск анализа критика в отдельном job или шаге
      # - name: Run literary critic
      #   run: node src/literary_critic.js
      #   # ... и возможно обновление journal с critic_tags

  # (Опционально) Отдельный job для анализа, если он должен идти параллельно или после
  # analyze-entry:
  #   needs: generate-entry-and-image
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #     # ... (остальные шаги для анализа)

  # (Опционально) Отдельный job для публикации во ВКонтакте
  # post-to-vk:
  #   needs: generate-entry-and-image
  #   # ... (как и раньше, но зависит от generate-entry-and-image)
