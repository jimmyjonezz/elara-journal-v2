name: ĞĞ¾Ğ²Ğ¾Ğµ ÑÑÑĞµ + Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'   # ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 12 Ñ‡Ğ°ÑĞ¾Ğ² (3:00 Ğ¸ 15:00 UTC)

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-build"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create logs directory
        run: mkdir -p logs

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ (Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ ÑƒĞ¿Ğ°Ğ´Ñ‘Ñ‚)
      - name: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ°
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: node src/core/entryGenerator.js || echo "entryGenerator Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»ÑÑ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹ â†’ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ğ›Ğ¸Ñ‚ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· (ÑĞ°Ğ¼Ğ¾Ğµ Ñ‡Ğ°ÑÑ‚Ğ¾Ğµ Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ)
      - name: Ğ›Ğ¸Ñ‚ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· (ĞºÑ€Ğ¸Ñ‚Ğ¸Ğº)
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "ğŸ–‹ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºÑ€Ğ¸Ñ‚Ğ¸ĞºĞ°..."
          node src/core/literaryAnalyzer.js || echo "ĞĞ½Ğ°Ğ»Ğ¸Ğ· ĞºÑ€Ğ¸Ñ‚Ğ¸ĞºĞ° ÑƒĞ¿Ğ°Ğ» â†’ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞµÑÑ‚ÑŒ"
          echo "ĞšĞ¾Ğ´ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: $?"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸ Ğ´Ğ°Ğ¶Ğµ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
      - name: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
        if: always()
        run: |
          if ls logs/*.txt 1> /dev/null 2>&1; then
            echo "Ğ›Ğ¾Ğ³Ğ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹:"
            ls -la logs/
            git add --force logs/ || true
          else
            echo "Ğ›Ğ¾Ğ³Ğ¾Ğ² Ğ² ./logs/ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾"
            touch logs/no-logs.txt
            git add --force logs/no-logs.txt || true
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ (Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ)
      - name: Commit & push Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"

          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ÑÑ‘, Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾Ğ³Ğ»Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒÑÑ
          git add -f \
            data/journal.json \
            data/literary_analysis.json \
            data/tag_statistics.json \
            data/latest_image_prompt.txt \
            src/config/context.json \
            logs/ 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ° Ğ½ĞµÑ‚"
            exit 0
          fi

          git commit -m "auto: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ° + Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· + Ğ»Ğ¾Ğ³Ğ¸ (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸)" || echo "ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½"
          git push --force-with-lease || echo "Push Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑÑ (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚), Ğ½Ğ¾ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ Ğ»Ğ¾Ğ³Ğ¾Ğ² â€” Ğ½Ğ° Ğ²ÑÑĞºĞ¸Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹
      - name: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ ĞºĞ°Ğº Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-${{ github.run_id }}
          path: logs/
          retention-days: 10
          if-no-files-found: ignore

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
