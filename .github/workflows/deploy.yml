name: –ù–æ–≤–æ–µ —ç—Å—Å–µ

on:
  workflow_dispatch:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤ (–≤ 06:00 –∏ 18:00 UTC)
    - cron: '0 3 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 1. –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É logs/
      - name: Create logs directory
        run: mkdir -p logs

      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node src/core/entryGenerator.js

      - name: –ö—Ä–∏—Ç–∏–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node src/core/literaryAnalyzer.js
      - name: Check and force add logs
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–ø–∫–∏ logs/..."
          if [ -n "$(ls -A logs/ 2>/dev/null)" ]; then
            echo "üìÑ –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤:"
            ls -la logs/
            # --force –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç .gitignore –¥–ª—è —ç—Ç–∏—Ö —Ñ–∞–π–ª–æ–≤
            git add --force logs/
            echo "‚úÖ –õ–æ–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∏–Ω–¥–µ–∫—Å git."
          else
            echo "‚ÑπÔ∏è –ü–∞–ø–∫–∞ logs/ –ø—É—Å—Ç–∞."
          fi

      # 3. –ö–æ–º–º–∏—Ç–∏–º –í–°–Å
      - name: Commit and push updated files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
          git add data/journal.json
          git add data/literary_analysis.json
          git add data/tag_statistics.json
          git add data/latest_image_prompt.txt
          git add src/config/context.json
          
          # –õ–æ–≥–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ (–µ—Å–ª–∏ –±—ã–ª–∏)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞."
            exit 0
          fi
          
          echo "üìÅ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã, —Å–æ–∑–¥–∞—ë–º –∫–æ–º–º–∏—Ç..."
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ç–∫—É
          git pull --ff-only || {
            git pull --rebase || {
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É."
              exit 1
            }
          }
          
          # –ö–æ–º–º–∏—Ç–∏–º
          git commit -m "üìù –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∂—É—Ä–Ω–∞–ª, –∞–Ω–∞–ª–∏–∑, —Ç–µ–≥–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ª–æ–≥–∏"
          
          # –ü—É—à–∏–º
          git push --force-with-lease          
          echo "‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—à–µ–Ω—ã."

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–Ω–∞–¥–µ–∂–Ω–µ–µ, —á–µ–º git)
      - name: Upload logs as artifact
        if: always() # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: logs/
          retention-days: 14
          if-no-files-found: ignore

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
