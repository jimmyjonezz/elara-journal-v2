# .github/workflows/deploy.yml
name: Deploy to GitHub Pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6,18 * * *' # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ pull
          fetch-depth: 0 

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate new journal entry
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node src/generate_entry.js

      # ===== –®–ê–ì: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ =====
      - name: Commit and push updated journal
        run: |
          # –î–æ–±–∞–≤–ª—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ data/journal.json
          git add data/journal.json # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  –§–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–∏—Ç."
            exit 0
          fi
          
          echo "üìÅ –§–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–º–∏—Ç..."
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
          # –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ "rejected"
          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É –∏–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
          git pull --ff-only || {
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É. –ü—Ä–æ–±—É–µ–º rebase..."
            # –ï—Å–ª–∏ fast-forward –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º rebase
            git pull --rebase || {
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É –¥–∞–∂–µ —Å rebase. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è."
              exit 1
            }
          }
          
          # –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –∫–æ–º–º–∏—Ç–∏–º –Ω–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          # –§–∞–π–ª —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–¥–µ–∫—Å –≤—ã—à–µ, –ø–æ—ç—Ç–æ–º—É –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
          
          git commit -m "üìù –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª –≠–ª–∞—Ä—ã"
          
          # –ü—É—à–∏–º —Å —Ñ–ª–∞–≥–æ–º --force-with-lease –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          echo "‚¨ÜÔ∏è  –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
          git push --force-with-lease
          
          echo "‚úÖ –ó–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞ –∏ –∑–∞–ø—É—à–µ–Ω–∞."
          
        # ===== –ö–û–ù–ï–¶ –®–ê–ì–ê =====

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
