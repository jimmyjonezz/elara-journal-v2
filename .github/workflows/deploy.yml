# .github/workflows/deploy.yml
name: Deploy to GitHub Pages

on:
  workflow_dispatch:
  schedule:
    # –û–±–Ω–æ–≤–ª–µ–Ω–æ: –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤ (–≤ 06:00 –∏ 18:00 UTC)
    # –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ~2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å, –∫–∞–∫ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π
    - cron: '0 6,18 * * *' 

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ pull/push
          fetch-depth: 0 

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate new journal entry
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node src/generate_entry.js

      # ===== –ù–û–í–´–ô –®–ê–ì: –ó–∞–ø—É—Å–∫ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –ö—Ä–∏—Ç–∏–∫–∞ =====
      # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –ü–û–°–õ–ï –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –µ—ë,
      # –Ω–æ –î–û –∫–æ–º–º–∏—Ç–∞ –∂—É—Ä–Ω–∞–ª–∞, —á—Ç–æ–±—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ—ë –≤–º–µ—Å—Ç–µ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏.
      - name: Run Literary Critic Analysis
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # VERCEL_URL: ${{ vars.VERCEL_URL }} # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫—Ä–∏–ø—Ç–µ
        run: |
          echo "üñãÔ∏è –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –∫—Ä–∏—Ç–∏–∫ –ø—Ä–∏—Å—Ç—É–ø–∞–µ—Ç –∫ –∞–Ω–∞–ª–∏–∑—É –∂—É—Ä–Ω–∞–ª–∞ (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å)..."
          node src/literary_critic.js
          echo "‚úÖ –ê–Ω–∞–ª–∏–∑ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –∫—Ä–∏—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω. –§–∞–π–ª literary_analysis.json —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω."
      # ===== –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –®–ê–ì–ê =====

      # ===== –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –®–ê–ì: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ =====
      # –¢–µ–ø–µ—Ä—å –º—ã –∫–æ–º–º–∏—Ç–∏–º –ò –∂—É—Ä–Ω–∞–ª, –ò –∞–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏–∫–∞.
      - name: Commit and push updated journal and analysis
        run: |
          # –î–æ–±–∞–≤–ª—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞ –≤ –∏–Ω–¥–µ–∫—Å
          git add data/journal.json data/literary_analysis.json
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–∞—Ö
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∂—É—Ä–Ω–∞–ª–µ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–ª—è –∫–æ–º–º–∏—Ç–∞."
            exit 0
          fi
          
          echo "üìÅ –§–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ –∏–ª–∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–º–∏—Ç..."
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
          # –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ "rejected"
          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É –∏–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
          git pull --ff-only || {
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É. –ü—Ä–æ–±—É–µ–º rebase..."
            # –ï—Å–ª–∏ fast-forward –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º rebase
            git pull --rebase || {
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É –¥–∞–∂–µ —Å rebase. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è."
              exit 1
            }
          }
          
          # –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –∫–æ–º–º–∏—Ç–∏–º –Ω–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git commit -m "üìù –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª –≠–ª–∞—Ä—ã + –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑"
          
          # –ü—É—à–∏–º —Å —Ñ–ª–∞–≥–æ–º --force-with-lease –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          echo "‚¨ÜÔ∏è  –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
          git push --force-with-lease
          
          echo "‚úÖ –ó–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞ –∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –∑–∞–ø—É—à–µ–Ω—ã."
        # ===== –ö–û–ù–ï–¶ –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –®–ê–ì–ê =====

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
