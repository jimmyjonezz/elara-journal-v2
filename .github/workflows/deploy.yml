name: –ù–æ–≤–æ–µ —ç—Å—Å–µ

on:
  workflow_dispatch:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤ (–≤ 06:00 –∏ 18:00 UTC)
    - cron: '0 6 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # üîπ –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É logs/ –¥–ª—è —Å—ã—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
      - name: Create logs directory
        run: mkdir -p logs

      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node src/generate_entry.js

      - name: Run Literary Critic Analysis
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "üñãÔ∏è –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –∫—Ä–∏—Ç–∏–∫ –ø—Ä–∏—Å—Ç—É–ø–∞–µ—Ç –∫ –∞–Ω–∞–ª–∏–∑—É –∂—É—Ä–Ω–∞–ª–∞ (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å)..."
          node src/literary_critic.js
          echo "‚úÖ –ê–Ω–∞–ª–∏–∑ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –∫—Ä–∏—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω. –§–∞–π–ª literary_analysis.json —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω."

      # üîπ –ö–æ–º–º–∏—Ç–∏–º –í–°–Å: –∂—É—Ä–Ω–∞–ª, –∞–Ω–∞–ª–∏–∑, —Ç–µ–≥–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –ª–æ–≥–∏
      - name: Commit and push updated files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –í–°–ï –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–≤–∫–ª—é—á–∞—è logs/, –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏)
          git add data/journal.json
          git add data/literary_analysis.json
          git add data/dynamic_tags.json
          git add data/tag_statistics.json
          git add data/latest_image_prompt.txt
          git add logs/

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞."
            exit 0
          fi
          
          echo "üìÅ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã, —Å–æ–∑–¥–∞—ë–º –∫–æ–º–º–∏—Ç..."
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ç–∫—É
          git pull --ff-only || {
            git pull --rebase || {
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É."
              exit 1
            }
          }
          
          # –ö–æ–º–º–∏—Ç–∏–º
          git commit -m "üìù –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∂—É—Ä–Ω–∞–ª, –∞–Ω–∞–ª–∏–∑, —Ç–µ–≥–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ª–æ–≥–∏"
          
          # –ü—É—à–∏–º
          git push --force-with-lease
          
          echo "‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—à–µ–Ω—ã."

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
