# .github/workflows/deploy.yml
name: Deploy to GitHub Pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC

# –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
permissions:
  contents: write # <-- –ù–∞–º –Ω—É–∂–Ω–æ —ç—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è git push
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # –í–∞–∂–Ω–æ: —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–∫–µ–Ω—É –¥–µ–ª–∞—Ç—å push
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # cache: 'npm' # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –µ—Å–ª–∏ –±—É–¥–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å package-lock.json

      # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
      # - name: Install dependencies
      #   run: npm install

      - name: Generate new journal entry
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node src/generate_entry.js

      # ===== –ù–û–í–´–ô –®–ê–ì: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ =====
      - name: Commit and push updated journal
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ data/journal.json
          git diff --quiet data/journal.json || JOURNAL_CHANGED=true
          if [ "$JOURNAL_CHANGED" = true ]; then
            echo "üìÅ –§–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω. –ö–æ–º–º–∏—Ç–∏–º..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add data/journal.json
            git commit -m "üìù –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª –≠–ª–∞—Ä—ã"
            git push
            echo "‚úÖ –ó–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞ –∏ –∑–∞–ø—É—à–µ–Ω–∞."
          else
            echo "‚ÑπÔ∏è  –§–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–∏—Ç."
          fi
        # ===== –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –®–ê–ì–ê =====

      - name: Setup Pages
        uses: actions/configure-pages@v5

      # –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.' # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—ë –∏–∑ –∫–æ—Ä–Ω—è

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
