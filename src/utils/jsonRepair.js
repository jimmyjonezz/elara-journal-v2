// src/utils/jsonRepair.js

/**
 * –ü—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ JSON –æ—Ç LLM
 */
function repairJSON(rawText) {
  let text = rawText.trim();

  // 1. –£–¥–∞–ª—è–µ–º markdown-–æ–±—ë—Ä—Ç–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å (```json ... ```)
  text = text.replace(/^```json\s*/i, '').replace(/```$/, '');
  text = text.replace(/^```\s*/i, '').replace(/```$/, '');

  // 2. –£–¥–∞–ª—è–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã (Zero-width spaces, BOM –∏ —Ç.–¥.)
  text = text.replace(/[\u200B-\u200D\uFEFF]/g, '');

  // 3. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º "—Ä—É—Å—Å–∫–∏–µ" –∫–∞–≤—ã—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å –ø–µ—Ä–µ–ø—É—Ç–∞–ª–∞)
  // –ó–∞–º–µ–Ω—è–µ–º ¬´ –∏ ¬ª –Ω–∞ " —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
  text = text.replace(/"([^"]*)¬´([^¬ª]*)¬ª([^"]*)"/g, '"$1"$2"$3"');

  // 4. –£–¥–∞–ª—è–µ–º trailing commas –ø–µ—Ä–µ–¥ ] –∏–ª–∏ }
  text = text.replace(/,(\s*[}\]])/g, '$1');

  // 5. –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ (–µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã)
  // –≠—Ç–æ —Å–ª–æ–∂–Ω–∞—è –∑–∞–¥–∞—á–∞, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
  text = text.replace(/(?<!\\)'/g, "\\'");

  return text;
}

/**
 * –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON —Å –ø–æ–ø—ã—Ç–∫–æ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
 */
function safeParseJSON(rawText, maxRetries = 2) {
  for (let i = 0; i <= maxRetries; i++) {
    try {
      // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ ‚Äî –∫–∞–∫ –µ—Å—Ç—å
      if (i === 0) {
        return JSON.parse(rawText);
      }
      
      // –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ø—ã—Ç–∫–∏ ‚Äî —Å —Ä–µ–º–æ–Ω—Ç–æ–º
      const repaired = repairJSON(rawText);
      return JSON.parse(repaired);
      
    } catch (e) {
      console.warn(`‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ${i + 1} –Ω–µ —É–¥–∞–ª–∞—Å—å: ${e.message}`);
      
      if (i === maxRetries) {
        // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã ‚Äî –ª–æ–≥–∏—Ä—É–µ–º –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º
        console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ —Ä–µ–º–æ–Ω—Ç–∞");
        console.error("üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞:", rawText.slice(-500));
        throw e;
      }
      
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏ —Å —Ä–µ–º–æ–Ω—Ç–æ–º
    }
  }
}

module.exports = { safeParseJSON, repairJSON };
