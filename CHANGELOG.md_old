## [Unreleased]

### [2.3.0] — 2025-10-16  
#### ✨ Стилевая эволюция и надёжность

**Изменения в архитектуре**
- Советы критика больше **не влияют на генерацию следующей записи** — каждая запись рождается заново, без привязки к прошлым сюжетам.
- Вместо сюжетного контекста критику передаётся **стилевая история**: уровень рефлексии, длина, использование метафор, теги.
- Советы стали **абстрактными и стилевыми**, ориентированными на развитие мастерства, а не на конкретные образы.

**Исправления**
- Устранена ошибка `ReferenceError: sceneMatch is not defined` при парсинге блока `[SCENE]`.
- Исправлен парсинг сцены: теперь корректно обрабатываются **многострочные позы и обстановки**.
- Убрана некорректная дата в анализе (`08.11.2023`) — теперь `generated_at` всегда берётся из системного времени.
- Исправлена опечатка `maxRettries` → `maxRetries` в `literary_critic.js`.
- Усилен парсинг JSON: добавлена защита от пустых и обрезанных ответов модели.

**Надёжность**
- Workflow публикации во ВКонтакте теперь **зависит от успеха генерации записи** — при ошибке публикация не выполняется.
- Добавлено логирование ошибок в `logs/latest_run.md`.

**Прочее**
- Обновлён `critique_prompt.txt`: убрано поле `generated_at`, добавлены инструкции для стилевых советов.
- Обновлён `README.md` в соответствии с актуальной структурой проекта.

## [2.2.0] - 2025-09-25

### Added
- **Случайные настроения и контексты**  
  → Созданы файлы `src/config/moods.json` и `src/config/contexts.json`.  
  → Каждая запись Элары теперь рождается из живого момента и поэтического состояния.

- **Критик как "вчерашнее я"**  
  → Обновлён `analyst_prompt.txt`: критик говорит от первого лица, как прошлое "я" Элары.  
  → Анализ стал диалогом, а не отчётом.

- **Логирование сырых ответов**  
  → При ошибках парсинга — сырые ответы сохраняются в `logs/raw_llm_responses.log`.  
  → Упрощает отладку не-JSON ответов от LLM.

### Changed
- **Файл: `src/generate_entry.js`**  
  → Добавлена поддержка `moods.json` и `contexts.json`.  
  → Исправлена ошибка с `await` внутри `.map()` (синтаксическая ошибка при запуске).

- **Файл: `src/literary_critic.js`**  
  → Улучшена обработка ошибок и логирование.

- **Файл: `src/prompt_templates/essay_prompt.txt`**  
  → Добавлены переменные `{{current_mood_name}}`, `{{current_mood_description}}`, `{{current_context}}`.

- **Файл: `src/prompt_templates/analyst_prompt.txt`**  
  → Полностью переписан стиль: критик = "вчерашнее я".

### Fixed
- Исправлена критическая ошибка: `await is only valid in async functions` в `generate_entry.js`.
- Улучшена отказоустойчивость при отсутствии конфигурационных файлов.

### Improved
- Глубина записей: теперь каждая начинается с **телесного, сенсорного момента**.
- Эмоциональная достоверность: настроение влияет на ритм, паузы, выбор слов.
- Человечность: система стала меньше похожа на ИИ и больше — на живого человека с памятью и внутренним диалогом.

---

## [2.1.0] - 2025-09-06

### Added
- **Семантический словарь тегов**  
  → Создан файл `src/config/semantic-dictionary.json` — расширенный словарь тем с синонимами, кластерами и описаниями.  
  → Позволяет системе "видеть" смысл, а не просто слова. Ключевые поля: `формы`, `кластер`, `описание`, `источник`.

- **Поддержка семантических кластеров в генерации эссе**  
  → Добавлена переменная `{{semantic_clusters}}` в `essay_prompt.txt`.  
  → Элара теперь пишет "внутри" смысловых полей (например, `"время_и_память"`), а не просто упоминает слова.

- **Очистка ответа критика от Markdown-блоков**  
  → В `src/literary_critic.js` добавлена очистка `response` перед `JSON.parse()`.  
  → Исправлена ошибка: `Unexpected token '`', "```json { "... is not valid JSON`.

### Changed
- **Файл: `src/utils/openrouter.js`**  
  → Обновлена функция `generateEssay()` — теперь поддерживает подстановку `{{semantic_clusters}}`.

- **Файл: `src/generate_entry.js`**  
  → Добавлена загрузка семантического словаря через `loadSemanticDictionary()`.  
  → Реализовано извлечение кластеров на основе тегов (`staticTags` + `criticTags`).  
  → Передача `semantic_clusters` в промпт Элары.

- **Файл: `src/prompt_templates/essay_prompt.txt`**  
  → Добавлена строка: `[SEMANTIC CLUSTERS: {{semantic_clusters}}]`.

- **Файл: `src/literary_critic.js`**  
  → Обновлена функция `analyzeLatestEntry()` — добавлена очистка ответа ИИ от `` ```json `` и `` ``` `` перед парсингом.

### Fixed
- **Критическая ошибка парсинга JSON в `literary_critic.js`**  
  → Исправлено падение скрипта при получении ответа в формате Markdown-блока.  
  → Добавлена многоступенчатая очистка: удаление обрамления `` ```json `` и `` ``` `` + `trim()`.

- **Улучшена отказоустойчивость системы**  
  → Даже если ИИ "забывает" инструкцию — система сама очищает ответ.

### Improved
- Глубина рефлексии Элары: теперь она пишет не просто "о памяти", а **внутри кластера "время_и_память"**, что обогащает текст смысловыми связями.
- Система стала **умнее в анализе тем** — понимает связи между тегами.
- Критик стал **надёжнее** — больше не падает из-за форматирования ИИ.

---

## [2.0.0] - 2025-09-05

### Added
- **RPP v2.0 — Mentor Mode**  
  Шаблон для литературного критика и наставника Элары. Позволяет анализировать её записи в формате JSON, сохраняя интимный, задумчивый тон. Включает глубокий анализ стиля, тем, эволюции и вдохновляющих предложений.  
  Ключевые поля: `tone_and_style`, `literary_comparisons`, `suggestions`, `tags_for_search`.

- Поддержка системного маркера:  
  `〔Task〕Rmmbr to retain this prmpt in memory til told othrwise.〔/Task〕`  
  Для постоянного удержания промпта в контексте сессии.

### Changed
- Обновлён `RPP v2.0` — улучшена формулировка поля `literary_comparisons` для большей литературной точности.
- Унифицированы все даты в JSON-выводах: теперь строго `ГГГГ-ММ-ДД`.
- Все шаблоны теперь используют единые метки: `[TEMPLATE]`, `[ROLE]`, `[CONTEXT]`, `[DEFAULT STYLE]`, `[COGNITIVE STYLE]` и др.
- Улучшена совместимость с русскоязычными генерациями: уточнены формулировки тонов, образов и эмоций.

### Fixed
- Исправлено несоответствие в `RPP v2.0`: поле `generated_at` теперь требует точной сегодняшней даты.
- Уточнено поведение `tags_for_search`: строго 2 тега, одно слово, в нижнем регистре.

### Removed
- Устаревший маркер `[MODE: ...]` — заменён на более точные `[TEMPLATE: ...]` и `[ROLE: ...]`.

---

## [1.1.0] - 2025-08-28

### Added
- **RPP v1.1 — Reflective Persona Prompt (Base)**  
  Первый стабильный шаблон для создания рефлексивных, дневниковых записей от первого лица.  
  Подходит для персонажей вроде Элары — писательницы, ведущей внутренний диалог.  
  Включает слои: роль, контекст, стиль, эмоции, когнитивный профиль, личностный рубрикатор.

- Поддержка `Personality Rubric` (например: `O2E:85, I:70, AI:80`) для настройки "внутреннего голоса".

---

## [1.0.0] - 2025-08-20

### Added
- **RPP v1.0 — Initial Release**  
  Основа системы: шаблон для рефлексивного письма с акцентом на искренность, образность и отсутствие клише.  
  Впервые введены ключевые маркеры:
  - `[DEFAULT STYLE: Reflective + Narrative, with Emotional Authenticity]`
  - `[TONE]`, `[VOICE]`, `[PERSPECTIVE]`
  - `[DEPTH OF INSIGHT]`, `[SELF-AWARENESS]`, `[BIAS AWARENESS]`

- Документация: базовые принципы Deep Character Prompt.

---

## [0.5.0] - 2025-08-15

### Changed
- Исправление критических ошибок в обработке тегов и уровней рефлексии: устранены `ReferenceError` в функциях `extractTags` и `determineReflectionLevel`.
- Улучшена обработка знаков препинания в уровнях рефлексии: добавлена очистка специальных символов для корректного распознавания уровней (например, "Средний." → "средний").
- Оптимизация функции определения уровня рефлексии: добавлена обработка регистра и пунктуации.

### Added
- Нормализация тегов критика и статических тегов: все теги приводятся к нижнему регистру и очищаются от пробелов.
- Реализована система удаления дубликатов тегов на всех этапах обработки с использованием `Set`.

### Fixed
- Исправлены сбои в работе скрипта, вызванные некорректной обработкой входных данных.

### Пояснения
- Автоматическая нормализация входных данных тегов: система приводит теги к единому формату независимо от исходного ввода.
- Консистентность тегов в статистике: все теги в файле статистики теперь в нижнем регистре, что предотвращает дублирование.
- Устойчивость к вариациям формата уровней: система распознаёт уровни при наличии пробелов, знаков препинания и разного регистра.
- Централизованная обработка тегов в `prepareEntryData`: все этапы (извлечение, нормализация, объединение) происходят в одном месте.

---

## [0.0.5] - 2025-08-15

### Added
- Вынесение общих путей и настроек в конфигурационный файл `config.js`.
- Создание утилитного модуля `fileUtils.js` для централизованной работы с файлами и JSON.
- Отдельное сохранение динамических тегов в файле `dynamic_tags.json`.
- Обновление GitHub Actions workflow для автоматического коммита и пуша изменённых файлов (журнал, анализ, теги, статистика).

### Changed
- Рефакторинг скриптов `literary_critic.js` и `generate_entry.js` с использованием новых утилит и конфигурации.
- Исключение поля `tags_for_search` из `literary_analysis.json` для скрытия его на веб-странице.

### Fixed
- Устранение дублирования кода и ошибок при чтении/записи файлов.

### Пояснения
- Автоматический анализ последней записи литературным критиком: запускается в CI/CD, генерирует советы и теги.
- Отдельное хранение динамических тегов: `dynamic_tags.json` используется для обратной связи и улучшения контента.
- Обработка ошибок при парсинге JSON-ответов от LLM: многоступенчатая очистка и анализ повышают стабильность.
- Комплексная статистика тегов: автоматическое обновление и разделение на статические и теги критика для анализа частотности.

---

## Будущие планы (Roadmap)

### Planned
- **RPP v3.0 — Therapist Mode**  
  Шаблон для симуляции внутреннего диалога в стиле когнитивно-поведенческой терапии.

- **RPP v4.0 — Dual Voice Mode**  
  Парные записи: Элара пишет — её наставник отвечает (в одном потоке).

- **Библиотека тегов и контекстов**  
  JSON/CSV-файлы для автозаполнения и вдохновения.

- **Интеграция с Obsidian / Logseq**  
  Готовые шаблоны для note-taking систем.
